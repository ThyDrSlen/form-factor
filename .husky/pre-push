#!/usr/bin/env sh
set -e
. "$(dirname "$0")/_/husky.sh"

if [ "${CI_LOCAL_SKIP:-}" = "1" ]; then
  echo "‚è≠Ô∏è  Skipping local CI checks (CI_LOCAL_SKIP=1)"
  exit 0
fi

echo "üöÄ Running full CI checks before push..."
python3 scripts/ci_local.py --quick

# EAS local iOS preview build policy:
# - Feature branches: skip by default (credential/signing mismatch should not block pushes)
# - main/develop: run by default
# - Override on any branch: CI_LOCAL_RUN_EAS_PREVIEW_LOCAL=1
# - Force skip on any branch: CI_LOCAL_SKIP_EAS_PREVIEW_LOCAL=1
branch_name="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo unknown)"
run_eas_preview_local="0"

case "$branch_name" in
  main|master|develop)
    run_eas_preview_local="1"
    ;;
esac

if [ "${CI_LOCAL_RUN_EAS_PREVIEW_LOCAL:-}" = "1" ]; then
  run_eas_preview_local="1"
fi

if [ "${CI_LOCAL_SKIP_EAS_PREVIEW_LOCAL:-}" = "1" ]; then
  echo "‚è≠Ô∏è  Skipping EAS local iOS preview build (CI_LOCAL_SKIP_EAS_PREVIEW_LOCAL=1)"
elif [ "$run_eas_preview_local" != "1" ]; then
  echo "‚è≠Ô∏è  Skipping EAS local iOS preview build on branch '$branch_name' (set CI_LOCAL_RUN_EAS_PREVIEW_LOCAL=1 to enable)"
elif [ "$(uname -s)" != "Darwin" ]; then
  echo "‚ö†Ô∏è  Skipping EAS local iOS preview build (requires macOS)"
else
  echo "üèóÔ∏è  Running EAS local iOS preview build..."
  mkdir -p build
  bunx eas build --platform ios --profile preview --local --non-interactive --output build/eas-preview.ipa
fi
